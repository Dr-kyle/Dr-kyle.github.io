<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Elasticsearch 聚合查询学习 - Kyle Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Kyle Zhao" /><meta name="description" content="Elasticsearch aggretation 学习" /><meta name="keywords" content="Elasticsearch, aggretation, es 聚合" />






<meta name="generator" content="Hugo 0.69.0 with theme even" />


<link rel="canonical" href="https://dr-kyle.github.io/post/elasticsearch/elasticsearch-aggregation/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="Elasticsearch 聚合查询学习" />
<meta property="og:description" content="Elasticsearch aggretation 学习" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://dr-kyle.github.io/post/elasticsearch/elasticsearch-aggregation/" />
<meta property="article:published_time" content="2020-05-24T17:52:14+08:00" />
<meta property="article:modified_time" content="2020-05-24T17:52:14+08:00" />
<meta itemprop="name" content="Elasticsearch 聚合查询学习">
<meta itemprop="description" content="Elasticsearch aggretation 学习">
<meta itemprop="datePublished" content="2020-05-24T17:52:14&#43;08:00" />
<meta itemprop="dateModified" content="2020-05-24T17:52:14&#43;08:00" />
<meta itemprop="wordCount" content="2859">



<meta itemprop="keywords" content="Elasticsearch," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Elasticsearch 聚合查询学习"/>
<meta name="twitter:description" content="Elasticsearch aggretation 学习"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Kyle Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">分类</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于我</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Kyle Blog</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">分类</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于我</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">Elasticsearch 聚合查询学习</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-05-24 17:52 </span>
        <div class="post-category">
            <a href="/categories/elasticsearch/"> Elasticsearch </a>
            </div>
          <span class="more-meta"> 约 2859 字 </span>
          <span class="more-meta"> 预计阅读 6 分钟 </span>
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    
    <div class="post-content">
      <p>Elasticsearch 聚合查询学习</p>
<h1 id="聚合查询">聚合查询</h1>
<h2 id="bucketing">Bucketing</h2>
<p>每个桶和一个文档的key相关联，符合条件的数据落入一个桶内</p>
<h3 id="adjacency-matrix-aggregation">Adjacency Matrix Aggregation</h3>
<p>邻接矩阵聚合,也就是求交集，假设es中的数据，  name: kyle 有2条， name: lola 有4条， name: aiden 有1条</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="err">//</span> <span class="err">如果两个过滤条件没有交集，则不会出现，例如</span> <span class="err">a</span> <span class="err">和</span> <span class="err">c</span> <span class="err">没有交集，返回的聚合结果中就没有</span> <span class="err">a&amp;c</span>
<span class="err">query:</span>
<span class="p">{</span>
  <span class="nt">&#34;size&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nt">&#34;aggs&#34;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&#34;interactions&#34;</span><span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;adjacency_matrix&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;filters&#34;</span><span class="p">:</span> <span class="p">{</span>
          <span class="nt">&#34;a&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;terms&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;name.keyword&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;kyle&#34;</span><span class="p">,</span> <span class="s2">&#34;lola&#34;</span><span class="p">]</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&#34;b&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;terms&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;name.keyword&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;lola&#34;</span><span class="p">,</span> <span class="s2">&#34;aiden&#34;</span><span class="p">]</span>
            <span class="p">}</span>
          <span class="p">},</span>
          <span class="nt">&#34;c&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;terms&#34;</span><span class="p">:</span> <span class="p">{</span>
              <span class="nt">&#34;name.keyword&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;aiden&#34;</span><span class="p">]</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="err">response:</span>
<span class="s2">&#34;aggregations&#34;</span> <span class="err">:</span> <span class="p">{</span>
    <span class="nt">&#34;interactions&#34;</span> <span class="p">:</span> <span class="p">{</span>
      <span class="nt">&#34;buckets&#34;</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="err">//</span> <span class="err">kyle</span> <span class="err">和</span> <span class="err">lola的总共有</span> <span class="err">6条</span>
          <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;a&#34;</span><span class="p">,</span>
          <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">6</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="err">//</span> <span class="err">a</span> <span class="err">和</span> <span class="err">b</span> <span class="err">相交的结果，也就是</span> <span class="err">kyle,</span> <span class="err">lola</span> <span class="err">和</span> <span class="err">lola,</span> <span class="err">aiden相交的结果是</span> <span class="err">lola，</span> <span class="err">有4条</span>
          <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;a&amp;b&#34;</span><span class="p">,</span>
          <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">4</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="err">//</span> <span class="err">lola</span> <span class="err">和</span> <span class="err">aiden</span> <span class="err">总共有5条</span>
          <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;b&#34;</span><span class="p">,</span>
          <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">5</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="err">//</span> <span class="err">lola</span> <span class="err">aiden和aiden的相交结果是</span> <span class="err">aiden，</span> <span class="err">结果有1条</span>
          <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;b&amp;c&#34;</span><span class="p">,</span>
          <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="p">{</span>
          <span class="err">//</span> <span class="err">aiden</span> <span class="err">有1条</span>
          <span class="nt">&#34;key&#34;</span> <span class="p">:</span> <span class="s2">&#34;c&#34;</span><span class="p">,</span>
          <span class="nt">&#34;doc_count&#34;</span> <span class="p">:</span> <span class="mi">1</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>

</code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th></th>
<th>a</th>
<th>b</th>
<th>c</th>
</tr>
</thead>
<tbody>
<tr>
<td>a</td>
<td>a</td>
<td>a&amp;b</td>
<td>a&amp;c</td>
</tr>
<tr>
<td>b</td>
<td></td>
<td>b</td>
<td>b&amp;c</td>
</tr>
<tr>
<td>c</td>
<td></td>
<td></td>
<td>c</td>
</tr>
</tbody>
</table>
<h3 id="auto-interval-date-histogram-aggregation">Auto-interval Date Histogram Aggregation</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-json" data-lang="json"><span class="err">POST</span> <span class="err">/sales/_search?size=</span><span class="mi">0</span>
<span class="p">{</span>
    <span class="nt">&#34;aggs&#34;</span> <span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;sales_over_time&#34;</span> <span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;auto_date_histogram&#34;</span> <span class="p">:</span> <span class="p">{</span>
                <span class="nt">&#34;field&#34;</span> <span class="p">:</span> <span class="s2">&#34;date&#34;</span><span class="p">,</span>
                <span class="err">//</span> <span class="err">default</span>
                <span class="nt">&#34;buckets&#34;</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                <span class="err">//</span> <span class="err">default</span> <span class="err">is</span> <span class="err">first</span> <span class="err">date</span> <span class="err">format</span>
                <span class="nt">&#34;format&#34;</span> <span class="p">:</span> <span class="s2">&#34;yyyy-MM-dd&#34;</span><span class="p">,</span>
                <span class="err">//</span> <span class="err">指定时区，ES默认使用UTC</span>
                <span class="nt">&#34;time_zone&#34;</span><span class="p">:</span> <span class="s2">&#34;-01:00&#34;</span><span class="p">,</span>
                <span class="err">//</span> <span class="nt">&#34;time_zone&#34;</span><span class="p">:</span> <span class="s2">&#34;America/Los_Angeles&#34;</span>
                <span class="err">//</span> <span class="err">指定最小舍入间隔</span>
                <span class="s2">&#34;minimum_interval&#34;</span><span class="p">:</span> <span class="s2">&#34;minute&#34;</span><span class="p">,</span>
                <span class="err">//</span> <span class="err">对于缺少值得文档的对待方式，默认丢弃，也可以通过以下添加该值</span>
                <span class="nt">&#34;missing&#34;</span><span class="p">:</span> <span class="s2">&#34;2000-01-01&#34;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="err">Reponse:</span>
<span class="p">{</span>
	<span class="nt">&#34;aggregations&#34;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&#34;sales_over_time&#34;</span><span class="p">:</span> <span class="p">{</span>
            <span class="nt">&#34;buckets&#34;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span>
                    <span class="nt">&#34;key_as_string&#34;</span><span class="p">:</span> <span class="s2">&#34;2015-01-01&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="mi">1420070400000</span><span class="p">,</span>
                    <span class="nt">&#34;doc_count&#34;</span><span class="p">:</span> <span class="mi">3</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="nt">&#34;key_as_string&#34;</span><span class="p">:</span> <span class="s2">&#34;2015-02-01&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="mi">1422748800000</span><span class="p">,</span>
                    <span class="nt">&#34;doc_count&#34;</span><span class="p">:</span> <span class="mi">2</span>
                <span class="p">},</span>
                <span class="p">{</span>
                    <span class="nt">&#34;key_as_string&#34;</span><span class="p">:</span> <span class="s2">&#34;2015-03-01&#34;</span><span class="p">,</span>
                    <span class="nt">&#34;key&#34;</span><span class="p">:</span> <span class="mi">1425168000000</span><span class="p">,</span>
                    <span class="nt">&#34;doc_count&#34;</span><span class="p">:</span> <span class="mi">2</span>
                <span class="p">}</span>
            <span class="p">],</span>
            <span class="nt">&#34;interval&#34;</span><span class="p">:</span> <span class="s2">&#34;1M&#34;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="composite-aggregation">Composite aggregation</h3>
<p>组合查询</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">{</span>
    <span class="s2">&#34;keyword&#34;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="s2">&#34;bar&#34;</span><span class="p">],</span>
    <span class="s2">&#34;number&#34;</span><span class="o">:</span> <span class="p">[</span><span class="mi">23</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">76</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-js" data-lang="js"><span class="p">{</span> <span class="s2">&#34;keyword&#34;</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="s2">&#34;number&#34;</span><span class="o">:</span> <span class="mi">23</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&#34;keyword&#34;</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="s2">&#34;number&#34;</span><span class="o">:</span> <span class="mi">65</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&#34;keyword&#34;</span><span class="o">:</span> <span class="s2">&#34;foo&#34;</span><span class="p">,</span> <span class="s2">&#34;number&#34;</span><span class="o">:</span> <span class="mi">76</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&#34;keyword&#34;</span><span class="o">:</span> <span class="s2">&#34;bar&#34;</span><span class="p">,</span> <span class="s2">&#34;number&#34;</span><span class="o">:</span> <span class="mi">23</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&#34;keyword&#34;</span><span class="o">:</span> <span class="s2">&#34;bar&#34;</span><span class="p">,</span> <span class="s2">&#34;number&#34;</span><span class="o">:</span> <span class="mi">65</span> <span class="p">}</span>
<span class="p">{</span> <span class="s2">&#34;keyword&#34;</span><span class="o">:</span> <span class="s2">&#34;bar&#34;</span><span class="p">,</span> <span class="s2">&#34;number&#34;</span><span class="o">:</span> <span class="mi">76</span> <span class="p">}</span>
<span class="s2">&#34;aggs&#34;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&#34;k&#34;</span><span class="o">:</span> <span class="p">{</span>
      <span class="s2">&#34;composite&#34;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&#34;sources&#34;</span><span class="o">:</span> <span class="p">[</span>
          <span class="p">{</span>
            <span class="s2">&#34;k1&#34;</span><span class="o">:</span> <span class="p">{</span>
              <span class="s2">&#34;terms&#34;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&#34;field&#34;</span><span class="o">:</span> <span class="s2">&#34;keyword.keyword&#34;</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">},{</span>
            <span class="s2">&#34;k2&#34;</span><span class="o">:</span> <span class="p">{</span>
              <span class="s2">&#34;terms&#34;</span><span class="o">:</span> <span class="p">{</span>
                <span class="s2">&#34;field&#34;</span><span class="o">:</span> <span class="s2">&#34;number&#34;</span>
                
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">]</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="date-histogram-aggregation">Date histogram aggregation</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">POST /sales/_search?size=0
{
    &#34;aggs&#34; : {
        &#34;sales_over_time&#34; : {
            &#34;date_histogram&#34; : {
                &#34;field&#34; : &#34;date&#34;,
                // minute(1m), hour(1h),day(1d),week(1w),month(1M),quarter(1q),year(1y)
                &#34;calendar_interval&#34; : &#34;month&#34;
                // milliseconds(ms), seconds(s), minutes(m), hours(h), days(d)
                // &#34;fixed_interval&#34; : &#34;30d&#34;
            }
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="date-range-aggregation">Date Range Aggregation</h3>
<p>range aggregation this is dedicated for date values. date 字段专用</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">以下创建两个bucket, 第一个 10个月以前的，第二个10个月以后的
POST /sales/_search?size=0
{
    &#34;aggs&#34;: {
        &#34;range&#34;: {
            &#34;date_range&#34;: {
                &#34;field&#34;: &#34;date&#34;,
                // &#34;keyed&#34;: true
                &#34;format&#34;: &#34;MM-yyyy&#34;,
                // how documents that are missing a value should be treated. 默认忽略
                &#34;missing&#34;: &#34;11-1976&#34;,
                &#34;ranges&#34;: [
                    // &lt; now minus 10 months, rounded down to the start of the month.
                    { &#34;to&#34;: &#34;now-10M/M&#34; }, 
                    // &gt;= now minus 10 months, rounded down to the start of the month.
                    { &#34;from&#34;: &#34;now-10M/M&#34; }
                    // now-10M &lt;= range &lt; now-5M
                    { 
                    	// 指定该bucket返回的key， 默认 和format相关， 
                    	&#34;key&#34;:&#34;from-to&#34;,
                    	&#34;to&#34;: &#34;now-5M/M&#34;,
                    	&#34;from&#34;: &#34;now-10M/M&#34; }
                ]
            }
        }
    }
}
Response:
&#34;aggregations&#34; : {
    &#34;range&#34; : {
      &#34;buckets&#34; : [
        {
          &#34;key&#34; : &#34;*-04-2020&#34;,
          &#34;to&#34; : 1.5856992E12,
          &#34;to_as_string&#34; : &#34;04-2020&#34;,
          &#34;doc_count&#34; : 3
        },
        {
          &#34;key&#34; : &#34;04-2020-*&#34;,
          &#34;from&#34; : 1.5856992E12,
          &#34;from_as_string&#34; : &#34;04-2020&#34;,
          &#34;to&#34; : 1.5882912E12,
          &#34;to_as_string&#34; : &#34;05-2020&#34;,
          &#34;doc_count&#34; : 3
        },
        {
          &#34;key&#34; : &#34;from-to&#34;,
          &#34;from&#34; : 1.5882912E12,
          &#34;from_as_string&#34; : &#34;05-2020&#34;,
          &#34;doc_count&#34; : 3
        }
      ]
    }
  }
  
  // 如果加入&#34;keyed&#34;: true 返回的 buckets的格式则为如下
  &#34;buckets&#34; : {
  	&#34;*-04-2020&#34;: 
  			{
          &#34;to&#34; : 1.5856992E12,
          &#34;to_as_string&#34; : &#34;04-2020&#34;,
          &#34;doc_count&#34; : 3
        },
       &#34;04-2020-*&#34;:
        {
          &#34;from&#34; : 1.5856992E12,
          &#34;from_as_string&#34; : &#34;04-2020&#34;,
          &#34;to&#34; : 1.5882912E12,
          &#34;to_as_string&#34; : &#34;05-2020&#34;,
          &#34;doc_count&#34; : 3
        },
        &#34;from-to&#34;:
        {
          &#34;from&#34; : 1.5882912E12,
          &#34;from_as_string&#34; : &#34;05-2020&#34;,
          &#34;doc_count&#34; : 3
        }
  }

</code></pre></td></tr></table>
</div>
</div><h3 id="filter-aggregation">Filter Aggregation</h3>
<p>通常用于将聚合应用于一组特定的文档。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">// 计算 t-shirt 的平均价格
POST /sales/_search?size=0
{
    &#34;aggs&#34; : {
        &#34;t_shirts&#34; : {
            &#34;filter&#34; : { &#34;term&#34;: { &#34;type&#34;: &#34;t-shirt&#34; } },
            &#34;aggs&#34; : {
                &#34;avg_price&#34; : { &#34;avg&#34; : { &#34;field&#34; : &#34;price&#34; } }
            }
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="filters-aggregation">Filters Aggregation</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">PUT /kyle_test_filters/_bulk?refresh
{ &#34;index&#34; : { &#34;_id&#34; : 1 } }
{ &#34;body&#34; : &#34;warning: page could not be rendered&#34; }
{ &#34;index&#34; : { &#34;_id&#34; : 2 } }
{ &#34;body&#34; : &#34;authentication error&#34; }
{ &#34;index&#34; : { &#34;_id&#34; : 3 } }
{ &#34;body&#34; : &#34;warning: connection timed out&#34; }
{ &#34;index&#34; : { &#34;_id&#34; : 4 } }
{ &#34;body&#34; : &#34;connection timed out&#34; }

GET kyle_test_filters/_search
{
  &#34;size&#34;: 0,
  &#34;aggs&#34; : {
    &#34;messages&#34; : {
      &#34;filters&#34; : {
        // 其他的值
        &#34;other_bucket_key&#34;: &#34;other_messages&#34;,
        &#34;filters&#34; : {
          &#34;errors&#34; :   { &#34;match&#34; : { &#34;body&#34; : &#34;error&#34;   }},
          &#34;warnings&#34; : { &#34;match&#34; : { &#34;body&#34; : &#34;warning&#34; }}
        }
      }
    }
  }
}
response:
&#34;aggregations&#34; : {
    &#34;messages&#34; : {
      &#34;buckets&#34; : {
        &#34;errors&#34; : {
          &#34;doc_count&#34; : 1
        },
        &#34;warnings&#34; : {
          &#34;doc_count&#34; : 2
        },
        &#34;other_messages&#34; : {
          &#34;doc_count&#34; : 1
        }
      }
    }
  }
GET kyle_test_filters/_search
{
  &#34;size&#34;: 0,
  &#34;aggs&#34; : {
    &#34;messages&#34; : {
      &#34;filters&#34; : {
        &#34;filters&#34; : [
          { &#34;match&#34; : { &#34;body&#34; : &#34;error&#34;   }},
          { &#34;match&#34; : { &#34;body&#34; : &#34;warning&#34; }},
          { &#34;match&#34; : { &#34;body&#34; : &#34;info&#34; }}
        ]
      }
    }
  }
}
response:
&#34;aggregations&#34; : {
    &#34;messages&#34; : {
      &#34;buckets&#34; : [
        {
          &#34;doc_count&#34; : 1
        },
        {
          &#34;doc_count&#34; : 2
        },
        {
          &#34;doc_count&#34; : 0
        }
      ]
    }
  }
</code></pre></td></tr></table>
</div>
</div><h3 id="global-aggreation">Global Aggreation</h3>
<p>Global aggregators can only be placed as top level aggregators</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">// 计算 t_shirts 价格的平均值和全部产品的平均值
POST /sales/_search?size=0
{
    &#34;query&#34; : {
        &#34;match&#34; : { &#34;type&#34; : &#34;t-shirt&#34; }
    },
    &#34;aggs&#34; : {
        &#34;all_products&#34; : {
            &#34;global&#34; : {}, 
            &#34;aggs&#34; : { 
                &#34;avg_price&#34; : { &#34;avg&#34; : { &#34;field&#34; : &#34;price&#34; } }
            }
        },
        &#34;t_shirts&#34;: { &#34;avg&#34; : { &#34;field&#34; : &#34;price&#34; } }
    }
}
response: 
&#34;aggregations&#34; : {
        &#34;all_products&#34; : {
            &#34;doc_count&#34; : 7, 
            &#34;avg_price&#34; : {
                &#34;value&#34; : 140.71428571428572 
            }
        },
        &#34;t_shirts&#34;: {
            &#34;value&#34; : 128.33333333333334 
        }
    }
</code></pre></td></tr></table>
</div>
</div><h3 id="histogram-aggregation">Histogram Aggregation</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">POST /sales/_search?size=0
{
    &#34;aggs&#34; : {
        &#34;prices&#34; : {
            &#34;histogram&#34; : {
                &#34;field&#34; : &#34;price&#34;,
                &#34;interval&#34; : 50
                // &#34;min_doc_count&#34; : 1
           
            }
        }
    }
}

Response:
POST /sales/_search?size=0
{
    ...
    &#34;aggregations&#34;: {
        &#34;prices&#34; : {
            &#34;buckets&#34;: [
                {
                    &#34;key&#34;: 0.0,
                    &#34;doc_count&#34;: 1
                },
                {
                    &#34;key&#34;: 50.0,
                    &#34;doc_count&#34;: 1
                },
                // 如果设置了 &#34;min_doc_count&#34; : 1，则该条不会返回
                {
                    &#34;key&#34;: 100.0,
                    &#34;doc_count&#34;: 0
                },
                {
                    &#34;key&#34;: 150.0,
                    &#34;doc_count&#34;: 2
                },
                {
                    &#34;key&#34;: 200.0,
                    &#34;doc_count&#34;: 3
                }
            ]
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="missing-aggregation">Missing Aggregation</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">该聚合器通常将与其他字段数据存储桶聚合器（例如范围）结合使用,以返回由于缺少字段数据值而无法放置在任何其他存储桶中的所有文档的信息。
POST /sales/_search?size=0
{
    &#34;aggs&#34; : {
        &#34;products_without_a_price&#34; : {
            &#34;missing&#34; : { &#34;field&#34; : &#34;price&#34; }
        }
    }
}

{
    ...
    &#34;aggregations&#34; : {
        &#34;products_without_a_price&#34; : {
            &#34;doc_count&#34; : 00
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="nested-aggregation">Nested Aggregation</h3>
<p>用于nested字段类型的聚合</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">PUT /products/_doc/0
{
  &#34;name&#34;: &#34;LED TV&#34;, 
  &#34;resellers&#34;: [
    {
      &#34;reseller&#34;: &#34;companyA&#34;,
      &#34;price&#34;: 350
    },
    {
      &#34;reseller&#34;: &#34;companyB&#34;,
      &#34;price&#34;: 500
    }
  ]
}
GET /products/_search
{
    &#34;query&#34; : {
        &#34;match&#34; : { &#34;name&#34; : &#34;led tv&#34; }
    },
    &#34;aggs&#34; : {
        &#34;resellers&#34; : {
            &#34;nested&#34; : {
                &#34;path&#34; : &#34;resellers&#34;
            },
            &#34;aggs&#34; : {
                &#34;min_price&#34; : { &#34;min&#34; : { &#34;field&#34; : &#34;resellers.price&#34; } }
            }
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="reverse-nested-aggregation">Reverse nested Aggregation</h3>
<p>待详细研究</p>
<h3 id="range-aggregation">Range Aggregation</h3>
<p>参考 Date Range Aggregation，类似</p>
<h3 id="rare-terms">Rare Terms</h3>
<p>就像是一个terms按_count 升序排序的聚合，实际上通过计数升序对术语agg进行排序具有无限误差</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /_search
{
    &#34;aggs&#34; : {
        &#34;genres&#34; : {
            &#34;rare_terms&#34; : {
                &#34;field&#34; : &#34;genre&#34;,
                // 最大100， 默认1
                &#34;max_doc_count&#34;: 2,
                &#34;include&#34; : [&#34;swing&#34;, &#34;rock&#34;],
                &#34;exclude&#34; : &#34;electro*&#34;
            }
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="significant_terms-aggregation">Significant_terms Aggregation</h3>
<h3 id="sampler-aggregation">Sampler Aggregation</h3>
<h3 id="diversified-sampler-aggregation">Diversified Sampler Aggregation</h3>
<p>先看significant_terms aggregation</p>
<h2 id="metrics">Metrics</h2>
<p>计算一组文档的指标</p>
<h3 id="cardinality-aggregation">Cardinality Aggregation</h3>
<p>计算不同值得近似计数</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">POST /sales/_search?size=0
{
    &#34;aggs&#34; : {
        &#34;type_count&#34; : {
            &#34;cardinality&#34; : {
                &#34;field&#34; : &#34;type&#34;
            }
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="stats-aggregation">Stats Aggregation</h3>
<p>The stats that are returned consist of: <code>min</code>, <code>max</code>, <code>sum</code>, <code>count</code> and <code>avg</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">POST /exams/_search?size=0
{
    &#34;aggs&#34; : {
        &#34;grades_stats&#34; : { &#34;stats&#34; : { &#34;field&#34; : &#34;grade&#34;, &#34;missing&#34;: 0 } }
    }
}
POST /exams/_search?size=0
{
    &#34;aggs&#34; : {
        &#34;grades_stats&#34; : {
             &#34;stats&#34; : {
                 &#34;script&#34; : {
                     &#34;lang&#34;: &#34;painless&#34;,
                     &#34;source&#34;: &#34;doc[&#39;grade&#39;].value&#34;
                 }
             }
         }
    }
}
POST /exams/_search?size=0
{
    &#34;aggs&#34; : {
        &#34;grades_stats&#34; : {
            &#34;stats&#34; : {
                &#34;script&#34; : {
                    &#34;id&#34;: &#34;my_script&#34;,
                    &#34;params&#34; : {
                        &#34;field&#34; : &#34;grade&#34;
                    }
                }
            }
        }
    }
}
POST /exams/_search?size=0
{
    &#34;aggs&#34; : {
        &#34;grades_stats&#34; : {
            &#34;stats&#34; : {
                &#34;field&#34; : &#34;grade&#34;,
                &#34;script&#34; : {
                    &#34;lang&#34;: &#34;painless&#34;,
                    &#34;source&#34;: &#34;_value * params.correction&#34;,
                    &#34;params&#34; : {
                        &#34;correction&#34; : 1.2
                    }
                }
            }
        }
    }
}
response:
{
    ...

    &#34;aggregations&#34;: {
        &#34;grades_stats&#34;: {
            &#34;count&#34;: 2,
            &#34;min&#34;: 50.0,
            &#34;max&#34;: 100.0,
            &#34;avg&#34;: 75.0,
            &#34;sum&#34;: 150.0
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="extended-stats-aggregation">Extended Stats Aggregation</h3>
<p>对stats的扩展</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET /exams/_search
{
    &#34;size&#34;: 0,
    &#34;aggs&#34; : {
        &#34;grades_stats&#34; : { &#34;extended_stats&#34; : { &#34;field&#34; : &#34;grade&#34; } }
    }
}
{
    ...

    &#34;aggregations&#34;: {
        &#34;grades_stats&#34;: {
           &#34;count&#34;: 2,
           &#34;min&#34;: 50.0,
           &#34;max&#34;: 100.0,
           &#34;avg&#34;: 75.0,
           &#34;sum&#34;: 150.0,
           &#34;sum_of_squares&#34;: 12500.0,
           &#34;variance&#34;: 625.0,
           &#34;std_deviation&#34;: 25.0,
           &#34;std_deviation_bounds&#34;: {
            &#34;upper&#34;: 125.0,
            &#34;lower&#34;: 25.0
           }
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="median-absolute-deviation-aggregation">Median Absolute Deviation Aggregation</h3>
<p>中位数绝对偏差</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">GET reviews/_search
{
  &#34;size&#34;: 0,
  &#34;aggs&#34;: {
    &#34;review_average&#34;: {
      &#34;avg&#34;: {
        &#34;field&#34;: &#34;rating&#34;
      }
    },
    &#34;review_variability&#34;: {
      &#34;median_absolute_deviation&#34;: {
        &#34;field&#34;: &#34;rating&#34; 
      }
    }
  }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="scripted-metric-aggregation">Scripted Metric Aggregation</h3>
<p>未明白含义</p>
<h3 id="string-stats-aggregation">String Stats Aggregation</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">POST /twitter/_search?size=0
{
    &#34;aggs&#34; : {
        &#34;message_stats&#34; : { &#34;string_stats&#34; : { &#34;field&#34; : &#34;message.keyword&#34; } }
    }
}
Response:
{
    ...

    &#34;aggregations&#34;: {
        &#34;message_stats&#34; : {
            // count - The number of non-empty fields counted.
            &#34;count&#34; : 5,
            // min_length - The length of the shortest term.
            &#34;min_length&#34; : 24,
            // max_length - The length of the longest term.
            &#34;max_length&#34; : 30,
            // avg_length - The average length computed over all terms.
            &#34;avg_length&#34; : 28.8,
            // 没懂什么含义。。
            &#34;entropy&#34; : 3.94617750050791
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="top-hits-aggregation">Top Hits Aggregation</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-fallback" data-lang="fallback">POST /sales/_search?size=0
{
    &#34;aggs&#34;: {
        &#34;top_tags&#34;: {
            &#34;terms&#34;: {
                &#34;field&#34;: &#34;type&#34;,
                &#34;size&#34;: 3
            },
            &#34;aggs&#34;: {
                &#34;top_sales_hits&#34;: {
                    &#34;top_hits&#34;: {
                        &#34;sort&#34;: [
                            {
                                &#34;date&#34;: {
                                    &#34;order&#34;: &#34;desc&#34;
                                }
                            }
                        ],
                        &#34;_source&#34;: {
                            &#34;includes&#34;: [ &#34;date&#34;, &#34;price&#34; ]
                        },
                        // &#34;from&#34;: 0
                        &#34;size&#34; : 1
                    }
                }
            }
        }
    }
}
</code></pre></td></tr></table>
</div>
</div><h3 id="top-hits-aggregation-1">Top Hits Aggregation</h3>
<p>值得研究，暂未看懂</p>
<h2 id="matrix">Matrix</h2>
<p>不支持脚本，可以在多个字段上操作，并根据请求的文档字段中提取的值生成矩阵结果。</p>
<h2 id="pipeline">Pipeline</h2>
<p>聚合其他聚合的输出结果及其相关指标</p>
    </div>

    
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/images/wechat-qr-code.jpg">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/images/alipay-qr-code.jpg">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/elasticsearch/">Elasticsearch</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/elasticsearch/elasticsearch-analyzer/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Elasticsearch Analyzer</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/oauth2-%E5%9B%9B%E7%A7%8D%E6%96%B9%E5%BC%8F/">
            <span class="next-text nav-default">OAuth2 四种认证方式</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="https://twitter.com/CrazyKyle_Zhao" class="iconfont icon-twitter" title="twitter"></a>
      <a href="https://github.com/Dr-kyle" class="iconfont icon-github" title="github"></a>
  <a href="https://dr-kyle.github.io/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2020 - 
    2021
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Kyle Zhao</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>








</body>
</html>
